<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>EaselJS Example: Rollovers and Drag & Drop</title>

<link href="styles.css" rel="stylesheet" type="text/css" />

<!-- Import EaselJS Framework -->
<script src="../easeljs/utils/UID.js"></script>
<script src="../easeljs/geom/Point.js"></script>
<script src="../easeljs/display/SpriteSheet.js"></script>
<script src="../easeljs/display/Shadow.js"></script>
<script src="../easeljs/display/DisplayObject.js"></script>
<script src="../easeljs/display/Container.js"></script>
<script src="../easeljs/display/Stage.js"></script>
<script src="../easeljs/display/Bitmap.js"></script>
<script src="../easeljs/display/BitmapSequence.js"></script>
<script src="../easeljs/display/Shape.js"></script>
<script src="../easeljs/utils/Tick.js"></script>
<script src="../easeljs/geom/Matrix2D.js"></script>
<!-- End EaselJS Imports -->

<script>

var canvas;
var stage;

var mouseTarget;	// the display object currently under the mouse, or being dragged
var dragStarted;	// indicates whether we are currently in a drag operation
var offset = new Point();

function init() {
	// create stage and point it to the canvas:
	canvas = document.getElementById("testCanvas");
	stage = new Stage(canvas);
	stage.mouseChildren = true;
	
	// attach mouse handlers directly to the source canvas:
	canvas.onmousemove = onMouseMove;
	canvas.onmousedown = onMouseDown;
	canvas.onmouseup = onMouseUp;
	
	// assign a tick listener directly to this window:
	Tick.addListener(window);
	
	// load the source image:
	var image = new Image();
	image.src = "img/daisy.png"
	image.onload = handleImageLoad;
}

function handleImageLoad(event) {
	var image = event.target;
	var bitmap;
	
	// create and populate the screen with random daisies:
	for(var i = 0; i < 30; i++){
		bitmap = new Bitmap(image);
		bitmap.x = canvas.width * Math.random()|0;
		bitmap.y = canvas.height * Math.random()|0;
		bitmap.rotation = 360 * Math.random()|0;
		bitmap.regX = bitmap.image.width/2|0;
		bitmap.regY = bitmap.image.height/2|0;
		bitmap.mouseEnabled = true;
		stage.addChild(bitmap);
	}
}

function tick() {
	// if we were dragging, but are not anymore, call mouseOut with the old target:
	if(!dragStarted && mouseTarget){ 
		onMouseOut(mouseTarget); 
		dragStarted = false;
	}
	
	// if we're not currently dragging, and have valid mouseX and mouseY values, check for objects under mouse:
	if(!dragStarted && stage.mouseX && stage.mouseY){
		// this will return the top-most display object under the mouse position:
		mouseTarget = stage.getObjectUnderPoint(stage.mouseX, stage.mouseY);
		if(mouseTarget){
			// if we found a target, call mouseOver with it:
			onMouseOver(mouseTarget);
			offset.x = mouseTarget.x-stage.mouseX;
			offset.y = mouseTarget.y-stage.mouseY;
		}
	}
	
	// if we're currently dragging something, update it's x/y:
	if(dragStarted && mouseTarget){
		// pop it to the top of the display list:
		stage.addChild(mouseTarget);
		mouseTarget.x = stage.mouseX+offset.x;
		mouseTarget.y = stage.mouseY+offset.y;
	}
	
	//Tick the display list (draw everything)
	stage.tick();
}


/**********************************
/** MOUSE HANDLERS 
**********************************/
// on mouse move, update the stage's mouseX/mouseY:
function onMouseMove(e) {
	if(!e){ var e = window.event; }
	stage.mouseX = e.pageX-canvas.offsetLeft;
	stage.mouseY = e.pageY-canvas.offsetTop;
}

// set flag to indicate we want to drag whatever is under the mouse:
function onMouseDown() {
	if(!e){ var e = window.event; }
	dragStarted = true;
}

// set flag to indicate we no longer want to drag:
function onMouseUp() {
	dragStarted = false;
}

// scale Display Objects on mouseOver / Out:
function onMouseOver(target){
	target.scaleX = target.scaleY = 1.1; 
}

function onMouseOut(target){
	target.scaleX = target.scaleY = 1; 
}


</script>
</head>
	
<body onload="init();">
	<div class="description">
	Example of implementing rollover and drag &amp; drop operations via the <strong>Stage.getObjectUnderPoint()</strong> method. This functionality is likely to be included in the core library in a future version. Some browsers do not allow access to pixel data when running local files, and may throw a security error.
	</div>
	<div class="canvasHolder">
		<canvas id="testCanvas" width="980" height="580"></canvas>
	</div>
</body>
</html>
